#!/bin/bash
#PBS -l nodes=1:ppn=1
#PBS -l walltime=12:00:00
#PBS -N dsi-studio-atk
#PBS -l vmem=8gb

set -e  

dwi=$(jq -r .dwi config.json)
bval=$(jq -r .bvals config.json)
bvec=$(jq -r .bvecs config.json)
# create symbolic link here
source=${dwi##*/}
ln -sf ${dwi} ${source}

# if SRC file is assigned use it instead
src=$(jq -r .src config.json)
if [[ [! -z "$src"] && "${src##*/}" -ne "null" ]]
then 
  source=${src##*/}
  ln -sf ${src} ${source}
  bval="";
  bvec="";
fi

# if FIB file is assigned use it instead
fib=$(jq -r .fib config.json)
if [[ [! -z "$fib"] && "${fib##*/}" -ne "null" ]]
then 
  source=${fib##*/}
  ln -sf ${fib} ${source}
  bval="";
  bvec="";
  mapping=$(jq -r .mapping config.json)
  if [ ! -z "$mapping" ]
  then 
    ln -sf ${mapping} ${source}.hcp1065.inv.mapping.gz
  fi
fi



# prepare parameters
resolution=$(jq -r .resolution config.json)
gqi_length_ratio=$(jq -r .gqi_length_ratio config.json)
tolerance=$(jq -r .tolerance config.json)
target=$(jq -r .target config.json)

if [ ! -z "$resolution" ]; then resolution="--interpolation=${resolution}"; fi
if [ ! -z "$gqi_length_ratio" ]; then gqi_length_ratio="--length_ratio=${gqi_length_ratio}"; fi
if [ ! -z "$tolerance" ]; then tolerance="--tolerance=${tolerance}"; fi
if [ ! -z "$target" ]; then target="--track_id=${target}"; fi
if [ ! -z "$bval" ]; then bval="--bval=${bval}"; fi
if [ ! -z "$bvec" ]; then bvec="--bvec=${bvec}"; fi


time singularity exec -e docker://dsistudio/dsistudio dsi_studio --action=atk --source=${source} ${bval} ${bvec} ${resolution} ${gqi_length_ratio} ${tolerance} ${target}

# move files
mkdir -p tts/tts
mv *.tt.gz tts/tts

mkdir -p fib
mv *.fib.gz fib/fib.gz
mv *.fib.gz.hcp1065.inv.mapping.gz fib/fib.gz.hcp1065.inv.mapping.gz

mkdir -p stat/tractmeasures
mv *.txt stat/tractmeasures

#!/bin/bash
#PBS -l nodes=1:ppn=1
#PBS -l walltime=12:00:00
#PBS -N dsi-studio-atk
#PBS -l vmem=8gb

set -e  

dwi=$(jq -r .dwi config.json)
bval=$(jq -r .bvals config.json)
bvec=$(jq -r .bvecs config.json)
# create symbolic link here
source=${dwi##*/}
ln -sf ${dwi} ${source}

# if SRC file is assigned use it instead
src=$(jq -r .src config.json)
if [ -f "$src" ]
then 
  source=${src##*/}
  ln -sf ${src} ${source}
  bval="";
  bvec="";
fi

# if FIB file is assigned use it instead
fib=$(jq -r .fib config.json)
if [ -f "$fib" ]
then 
  source=${fib##*/}
  ln -sf ${fib} ${source}
  bval="";
  bvec="";
  mapping=$(jq -r .mapping config.json)
  if [ -f "$mapping" ]
  then 
    ln -sf ${mapping} ${source}.hcp1065.inv.mapping.gz
  fi
fi

dwi_opposite=$(jq -r .dwi_opposite config.json)
if [ -f $dwi_opposite ]; then dwi_opposite="--other_src=${dwi_opposite}"; else dwi_opposite=""; fi

target=$(jq -r .target config.json)

if [ ! -z "$target" ]; then target="--track_id=${target}"; fi
if [ ! -z "$bval" ]; then bval="--bval=${bval}"; fi
if [ ! -z "$bvec" ]; then bvec="--bvec=${bvec}"; fi

# prepare parameters
other=$(jq -r .other config.json)
if [[ ${other:0:1} != '-' ]]
then 
  echo "other parameter not used"
  other=""
fi

time singularity exec -e docker://dsistudio/dsistudio dsi_studio --action=atk --source=${source} --report=report.txt ${bval} ${bvec} ${dwi_opposite} ${target} ${other}

report=$( cat report.txt )

# generate report
echo "{ \"meta\": {\"method\": \"${report}\"}, \"brainlife\": [ {\"type\": \"info\", \"msg\": \"${report}\"} ] }" > product.json

       
# move files
mkdir -p tts/tts
mv *.tt.gz tts/tts

if [ ! -f "$fib" ]
then
  mkdir -p fib
  mv *.fib.gz fib/fib.gz
  mv *.fib.gz.hcp1065.inv.mapping.gz fib/fib.gz.hcp1065.inv.mapping.gz
fi

mkdir -p stat/tractmeasures
mv *.txt stat/tractmeasures
